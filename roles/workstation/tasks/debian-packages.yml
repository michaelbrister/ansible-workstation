---

- name: Update apt packages
  apt:
    update_cache: yes
    cache_valid_time: 86400 # One day
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Upgrade all packages to the latest version
  apt:
    name: "*"
    state: latest

- name: Install base packages
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
    - apt-transport-https
    - ca-certificates
    - software-properties-common
    - git
    - curl
    - tree
    - neovim
    - net-tools
    - python3-neovim
    - python3-pip
    - openvpn-systemd-resolved
    - remmina
    - flameshot
    - htop
    - nload
    - virtualbox
    - direnv
    - build-essential
    - tmux
    - tmate
    - fonts-powerline
    - xclip
    - openjdk-17-jdk-headless
    - nmap
    - nodejs
    - httping
    - dnsutils
    - zsh
    - xclip
    - xsel
    - nala

##################
# Install pgadmin4
##################

- name: Add pgadmin key
  apt_key:
    url: "https://www.pgadmin.org/static/packages_pgadmin_org.pub"
    state: present
  tags:
    - pgadmin4

- name: Add pgadmin4 repository
  apt_repository:
    repo: deb [arch=amd64] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/{{ ansible_distribution_release }} pgadmin4 main
    filename: postgresql
    state: present
  tags:
    - pgadmin4

- name: Install pgamdin4
  apt:
    update_cache: yes
    name: pgadmin4
    state: present
  tags:
    - pgadmin4


###################
# Install 1password
###################

- name: Add 1password key
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/keys/1password.asc
    dest: /tmp/1password.asc
    mode: '0644'
    force: true
  tags:
    - 1password

- name: De-Armor Docker GPG key
  command:  gpg --dearmor < /tmp/1password.asc > /usr/share/keyrings/1password-archive-keyring.gpg
  changed_when: false
  become: true
  no_log: true

- name: Add 1password repository
  apt_repository:
    repo: deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main
    filename: 1password
    state: present
  tags:
    - 1password

- name: Create the debsig-verify policy directory
  ansible.builtin.file:
    path: /etc/debsig/policies/AC2D62742012EA22
    state: directory
    mode: '0755'
    force: true
  tags:
    - 1password
    
- name: Add the debsig-verify policy
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/debian/debsig/1password.pol
    dest: /etc/debsig/policies/AC2D62742012EA22/1password.pol
    mode: '0644'
    force: true
  tags:
    - 1password

- name: Create the debsig-verify policy directory
  ansible.builtin.file:
    path: /usr/share/debsig/keyrings/AC2D62742012EA22
    state: directory
    mode: '0755'
    force: true
  tags:
    - 1password

- name: Add the debsig-verify policy
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/keys/1password.asc
    dest: /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.asc
    mode: '0644'
    force: true
  tags:
    - 1password

- name: Install 1password
  apt:
    name: 1password
    state: present
  tags:
    - 1password

- name: Create 1Password directory
  ansible.builtin.file:
    path: /home/{{ lookup('env', 'USER') }}/.config/1Password/ssh
    state: directory
    recurse: yes
    mode: '0700'
  tags:
    - 1password

##########################
# Install hashicorp packer
##########################

- name: Add hashicorp apt key
  apt_key:
    url: "https://apt.releases.hashicorp.com/gpg"
    state: present
  tags:
    - packer

- name: Add hashicorp repository
  apt_repository:
    repo: "deb [arch=amd64] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    # repo: "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    filename: hashicorp
    state: present
  tags:
    - packer

- name: Install hashicorp packer
  apt:
    update_cache: yes
    name: packer
    state: present
  tags:
    - packer

######################################
# Install sublime text / sublime merge
######################################

- name: Add sublimetext apt key
  apt_key:
    url: "https://download.sublimetext.com/sublimehq-pub.gpg"
    state: present
  tags:
    - sublime-text

- name: Add sublimetext repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.sublimetext.com/ apt/stable/"
    filename: sublime 
    state: present
  tags:
    - sublime-text

- name: Install sublimetext & sublime merge
  apt:
    update_cache: yes
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - sublime-text
      - sublime-merge
  tags:
    - sublime-text

################
# Install docker
################

- name: Add docker key
  apt_key:
    url: "https://download.docker.com/linux/ubuntu/gpg"
    state: present
  tags:
    - docker

- name: Add docker repository
  apt_repository:
    update_cache: yes
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
    filename: docker
    state: present
  tags:
    - docker

- name: Install docker
  apt:
    name: docker-ce
    state: present
  tags:
    - docker

- name: Install docker-compose
  get_url:
    url: https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-Linux-x86_64
    dest: /usr/local/bin/docker-compose
    mode: 0755
  tags:
    - docker

- name: Add user to docker group
  user:
      name: "{{ lookup('env', 'USER') }}"
      group: "{{ lookup('env', 'USER') }}"
  tags:
    - docker

- name: Add user to docker group
  user:
      name: "{{ lookup('env', 'USER') }}"
      groups: docker 
      append: true
  tags:
    - docker

#################
# Install kubectl
#################

- name: Add kubectl key
  apt_key:
    url: "https://packages.cloud.google.com/apt/doc/apt-key.gpg"
    state: present
  tags:
    - k8s

- name: Add kubectl repository
  apt_repository:
    repo: deb [arch=amd64] https://apt.kubernetes.io/ kubernetes-xenial main
    filename: kubernetes
    state: present
  tags:
    - k8s

- name: Install kubectl
  apt:
    update_cache: yes
    name: kubectl
    state: present
  tags:
    - k8s

##################
# Install minikube
##################

- name: Add kubectl repository
  apt_repository:
    repo: deb [arch=amd64] https://apt.kubernetes.io/ kubernetes-xenial main
    state: present
  tags:
    - k8s

- name: Install minikube
  get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: '755'
  tags:
    - k8s

- name: Set minikube permissions
  file:
      path: /usr/local/bin/minikube
      owner: "{{ lookup('env', 'USER') }}"
      group: docker
      mode: '0755'
  tags:
    - k8s

######################
# Install OpenLens
######################

- name: Install Open Lens
  apt:
    deb: "{{ open_lens_url }}"
  tags:
    - lens

######################
# Install mozilla sops
######################

- name: Install mozilla sops
  apt:
    deb: "{{ sops_url }}"
  tags:
    - sops

##################################
# Install jwt-cli
##################################
- name: "jwt-cli | Extract archive"
  ansible.builtin.unarchive:
    src: https://github.com/mike-engel/jwt-cli/releases/download/4.0.0/jwt-linux.tar.gz
    dest: "/home/{{ lookup('env', 'USER') }}/.local/bin/"
    remote_src: yes
  tags:
    - jwt-cli

- name: "Set jwt-cli permissions"
  file:
      path: /home/{{ lookup('env', 'USER') }}/.local/bin/jwt
      owner: "{{ lookup('env', 'USER') }}"
      group: "{{ lookup('env', 'USER') }}"
      mode: '0755'
  tags:
    - jwt-cli

##############
# Install mage
# #############

- name: "mage installation"
  ansible.builtin.unarchive:
    src: "{{ mage_binary_url }}"
    dest: "/usr/local/bin/"
    include: 
    - mage
    remote_src: yes
  tags:
    - mage
